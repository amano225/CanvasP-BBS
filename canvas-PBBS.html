<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>canvasを使ったお絵描き投稿システム</title>
    <style>
        #mycanvas{
            border: 10px solid #999;
            cursor:crosshair;
        }
    </style>
</head>
<body>
    <p>
        <select id="penColor">
            <option value="black">黒</option>
            <option value="red">赤</option>
            <option value="blue">青</option>
            <option value="rgb(100%,100%,100%)">白</option>
        </select>
        <select id="penWidth">
            <option value="1">細</option>
            <option value="3">中</option>
            <option value="5">太</option>
        </select>
        <input type="button" id="erase" value="消去">
        <input type="button" id="posting" value="投稿">
    </p>
    <canvas width="400" height="200" id="mycanvas">
        Canvasに対応したブラウザを用意してください。
    </canvas>
    <div>
        <p>最近投稿された画像</p>
        <img src="test.png" alt="">
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
        $(function(){
            var canvas = document.getElementById('mycanvas');
            if( !canvas || !canvas.getContext) return false;
            var ctx = canvas.getContext('2d');
            
            var startX, startY, x, y;
            var thisX, thisY;
            var borderWidth = 10;
            var isDrawing = false;
            $('#mycanvas').on('touchstart mousedown', function(e){
                //console.log(e);
                //console.log(e.preventDefault);
                //console.log("touchstart mousedown");
                thisX = e.pageX || e.originalEvent.changedTouches[0].pageX;
                thisY = e.pageY || e.originalEvent.changedTouches[0].pageY;
                //console.log("thisX:" + thisX + ",thisY:" + thisY);
                
                startX = thisX - $(this).offset().left - borderWidth;
                startY = thisY - $(this).offset().top - borderWidth;
                isDrawing = true;
                
                //console.log("X:" + startX + ",Y:" + startY);
                
                e.preventDefault();
            })
            .on('touchmove mousemove',function(e){
                if(!isDrawing) return;
                thisX = e.pageX || e.originalEvent.changedTouches[0].pageX;
                thisY = e.pageY || e.originalEvent.changedTouches[0].pageY;
                x = thisX - $(this).offset().left - borderWidth;
                y = thisY - $(this).offset().top - borderWidth;
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(x, y);
                ctx.stroke();
                startX = x;
                startY = y;
                
                e.preventDefault();
            })
            .on('touchend mouseup', function(){
                //console.log("touchend mouseup");
                isDrawing = false;
            })
            .on('touchleave mouseleave', function(e){
                //console.log("touchleave mouseleave");
                if(!isDrawing) return;
                e.preventDefault();
                thisX = e.pageX || e.originalEvent.changedTouches[0].pageX;
                thisY = e.pageY || e.originalEvent.changedTouches[0].pageY;
                x = thisX - $(this).offset().left - borderWidth;
                y = thisY - $(this).offset().top - borderWidth;
                
                console.log("x:" + x);
                console.log("y:" + y);
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(x, y);
                ctx.stroke();
                startX = x;
                startY = y;
                
                isDrawing = false;
            });
            
            $('#penColor').change(function(){
                ctx.strokeStyle = $(this).val();
            });
            
            $('#penWidth').change(function(){
                ctx.lineWidth = $(this).val();
            });
            
            $('#erase').click(function(){
                if(!confirm('本当に消去しますか?')) return; 
                ctx.clearRect(0,0,canvas.width, canvas.height);
            });
            
            $('#posting').click(function(){
                canvas = $('#mycanvas')[0].toDataURL();
                $.ajax({
                    type: 'POST',
                    url: 'image-accept.php',
                    data: {
                        acceptImage: canvas
                    },
                    success:function(data, dataType){
                        //console.log("succcess");
                        //console.log(data);
                        var $img = $('img');
                        var imgSrc = $img.attr('src');
                        $img.attr('src', "");
                        $img.attr('src', imgSrc);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        //console.log("error");
                        //console.log(XMLHttpRequest);
                        //console.log(textStatus);
                    }
                    
                });
            });
        });
    </script>
</body>
</html>